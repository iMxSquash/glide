name: Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Clean install dependencies
        run: |
          if (Test-Path package-lock.json) { Remove-Item package-lock.json }
          if (Test-Path node_modules) { Remove-Item -Recurse -Force node_modules }
          npm install
        shell: pwsh

      - name: Build all
        run: npm run build:all

      - name: Build Windows
        run: npm run dist:win

      - name: List Windows build output
        shell: bash
        run: |
          echo "Contents of apps/server-electron/out:"
          ls -la apps/server-electron/out/ || echo "Directory not found"
          find apps/server-electron/out -name "*.exe" -type f || echo "No .exe found"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: apps/server-electron/out/

  create-release:
    needs: build-windows
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: ./dist-windows

      - name: List files (debug)
        run: |
          echo "Windows files:"
          ls -laR ./dist-windows/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist-windows/**/*
          body: |
            ## Glide ${{ github.ref_name }}

            ### üì¶ Installation Windows

            - T√©l√©charger le fichier `.exe`
            - Lancer l'installateur
            - L'app d√©marre dans la barre syst√®me

            ### üöÄ Utilisation

            1. Lancer Glide sur ton PC
            2. Noter le PIN et l'IP affich√©s
            3. Sur iPhone Safari: `https://<IP>:3000`
            4. Entrer le PIN
            5. Contr√¥ler le PC avec les gestes trackpad !

            ### üî• Fonctionnalit√©s
            - ‚úÖ Gestion automatique du firewall Windows
            - ‚úÖ Certificat auto-sign√© avec IP SAN
            - ‚úÖ PIN r√©g√©n√©r√© √† chaque lancement
            - ‚úÖ R√©seau local uniquement (s√©curis√©)
            - ‚úÖ PWA installable sur iPhone
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
